<!-- src/app/profile/components/profile-addresses/profile-addresses.component.html -->
<section id="mis-direcciones">
  <!-- 1. Cabecera y Botón "Añadir" -->
  <div class="flex flex-col p-4 pb-0 lg:p-0">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
      <div>
        <p
          class="text-text-light-primary text-3xl font-bold leading-tight tracking-tight"
        >
          Mis Direcciones
        </p>
        <p
          class="text-text-light-secondary text-base font-normal leading-normal pt-2"
        >
          Administra tus direcciones de envío guardadas.
        </p>
      </div>
      <button
        *ngIf="!showForm"
        (click)="toggleForm()"
        class="flex mt-4 sm:mt-0 max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-11 bg-secondary text-white gap-2 text-sm font-bold min-w-0 px-6 hover:bg-secondary-dark transition-colors"
      >
        Añadir Nueva Dirección
      </button>
    </div>
  </div>

  <!-- 2. Formulario de Crear/Editar (Oculto por defecto) -->
  <div
    *ngIf="showForm"
    class="bg-white p-6 rounded-xl border border-gray-200 mt-6"
  >
    <form
      [formGroup]="addressForm"
      (ngSubmit)="onFormSubmit()"
      class="flex flex-col gap-6"
    >
      <h3 class="text-lg font-semibold text-text-light-primary border-b pb-3">
        {{ isEditing ? "Editar Dirección" : "Añadir Nueva Dirección" }}
      </h3>

      <!-- Fila 1: Alias -->
      <label class="flex flex-col">
        <p class="text-text-light-primary text-sm font-medium pb-2">
          Alias (ej: Casa, Oficina)
        </p>
        <input
          formControlName="alias"
          class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-text-light-primary focus:outline-0 focus:ring-2 focus:ring-secondary focus:ring-opacity-50 border border-gray-300 bg-gray-50 h-12 placeholder:text-text-light-secondary px-4 text-base"
        />
        <div
          *ngIf="f['alias'].invalid && f['alias'].touched"
          class="text-red-500 text-xs mt-1"
        >
          El alias es obligatorio.
        </div>
      </label>

      <!-- Fila 2: Dirección -->
      <label class="flex flex-col">
        <p class="text-text-light-primary text-sm font-medium pb-2">Calle</p>
        <input
          formControlName="street"
          class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-text-light-primary focus:outline-0 focus:ring-2 focus:ring-secondary focus:ring-opacity-50 border border-gray-300 bg-gray-50 h-12 placeholder:text-text-light-secondary px-4 text-base"
        />
      </label>

      <!-- Fila 3: Ciudad y Provincia/Estado -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <label class="flex flex-col">
          <p class="text-text-light-primary text-sm font-medium pb-2">Ciudad</p>
          <input
            formControlName="city"
            class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-text-light-primary focus:outline-0 focus:ring-2 focus:ring-secondary focus:ring-opacity-50 border border-gray-300 bg-gray-50 h-12 placeholder:text-text-light-secondary px-4 text-base"
          />
        </label>
        <label class="flex flex-col">
          <p class="text-text-light-primary text-sm font-medium pb-2">
            Provincia / Estado
          </p>
          <input
            formControlName="state"
            class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-text-light-primary focus:outline-0 focus:ring-2 focus:ring-secondary focus:ring-opacity-50 border border-gray-300 bg-gray-50 h-12 placeholder:text-text-light-secondary px-4 text-base"
          />
        </label>
      </div>

      <!-- Fila 4: C. Postal y País -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <label class="flex flex-col">
          <p class="text-text-light-primary text-sm font-medium pb-2">
            Código Postal
          </p>
          <input
            formControlName="postalCode"
            class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-text-light-primary focus:outline-0 focus:ring-2 focus:ring-secondary focus:ring-opacity-50 border border-gray-300 bg-gray-50 h-12 placeholder:text-text-light-secondary px-4 text-base"
          />
        </label>
        <label class="flex flex-col">
          <p class="text-text-light-primary text-sm font-medium pb-2">País</p>
          <input
            formControlName="country"
            class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-text-light-primary focus:outline-0 focus:ring-2 focus:ring-secondary focus:ring-opacity-50 border border-gray-300 bg-gray-50 h-12 placeholder:text-text-light-secondary px-4 text-base"
          />
        </label>
      </div>

      <!-- Fila 5: Teléfono y Checkbox -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <label class="flex flex-col">
          <p class="text-text-light-primary text-sm font-medium pb-2">
            Teléfono (Opcional)
          </p>
          <input
            formControlName="phone"
            class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-text-light-primary focus:outline-0 focus:ring-2 focus:ring-secondary focus:ring-opacity-50 border border-gray-300 bg-gray-50 h-12 placeholder:text-text-light-secondary px-4 text-base"
          />
        </label>
        <div class="flex items-center pt-6">
          <label class="flex items-center gap-2 cursor-pointer">
            <input
              type="checkbox"
              formControlName="isDefault"
              class="size-5 rounded text-secondary focus:ring-secondary"
            />
            <span class="text-text-light-primary text-sm font-medium">
              Marcar como dirección por defecto
            </span>
          </label>
        </div>
      </div>

      <!-- Fila 6: Botones de Acción -->
      <div
        class="flex items-center gap-4 pt-4 border-t border-gray-200 flex-wrap"
      >
        <button
          [disabled]="submitting"
          class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-11 bg-secondary text-white gap-2 text-sm font-bold min-w-0 px-6 hover:bg-secondary-dark transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          type="submit"
        >
          <span *ngIf="submitting" class="animate-spin text-xl">↻</span>
          {{ submitting ? "Guardando..." : "Guardar Dirección" }}
        </button>
        <button
          (click)="cancelForm()"
          [disabled]="submitting"
          class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-11 bg-transparent text-gray-700 gap-2 text-sm font-bold min-w-0 px-6 border-2 border-gray-300 hover:bg-gray-100 transition-colors"
          type="button"
        >
          Cancelar
        </button>
      </div>
    </form>
  </div>

  <!-- 3. Lista de Direcciones Guardadas -->
  <div class="mt-8">
    <!-- Estado de Carga -->
    <div *ngIf="loading" class="text-center py-10 text-gray-500">
      Cargando direcciones...
    </div>

    <!-- Estado de Error -->
    <div *ngIf="error && !loading" class="text-center py-10 text-red-500">
      {{ error }}
    </div>

    <!-- Estado Vacío -->
    <div
      *ngIf="!loading && !error && addresses.length === 0 && !showForm"
      class="bg-white p-6 rounded-xl border border-gray-200 mt-6 text-center text-gray-500"
    >
      <p>No tienes ninguna dirección guardada.</p>
    </div>

    <!-- Lista -->
    <div *ngIf="!loading && addresses.length > 0" class="flex flex-col gap-4">
      <div
        *ngFor="let address of addresses"
        class="bg-white p-6 rounded-xl border border-gray-200 flex flex-col sm:flex-row sm:justify-between"
      >
        <!-- Detalles de la dirección -->
        <div class="flex-1">
          <p
            class="text-base font-semibold text-text-light-primary flex items-center gap-2"
          >
            {{ address.alias }}
            <span
              *ngIf="address.isDefault"
              class="text-xs font-medium px-2 py-0.5 rounded bg-blue-100 text-blue-800"
            >
              Principal
            </span>
          </p>
          <p class="text-sm text-text-light-secondary mt-1">
            {{ address.street }}<br />
            {{ address.city }}, {{ address.state }} {{ address.postalCode
            }}<br />
            {{ address.country }}
          </p>
          <p
            *ngIf="address.phone"
            class="text-sm text-text-light-secondary mt-2"
          >
            Teléfono: {{ address.phone }}
          </p>
        </div>

        <!-- Acciones -->
        <div class="flex gap-2 mt-4 sm:mt-0">
          <button
            (click)="toggleForm(address)"
            class="text-sm font-medium text-secondary hover:text-secondary-dark"
          >
            Editar
          </button>
          <span class="text-gray-300">|</span>
          <button
            (click)="onDeleteAddress(address.id)"
            class="text-sm font-medium text-red-600 hover:text-red-800"
          >
            Eliminar
          </button>
        </div>
      </div>
    </div>
  </div>
</section>
