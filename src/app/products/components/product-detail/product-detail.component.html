<main
  class="max-w-7xl mx-auto px-4 py-8 sm:py-12"
  *ngIf="!isLoading() && product() as prod; else loadingOrError"
>
  <nav class="text-sm mb-4" aria-label="Breadcrumb">
    <ol class="flex items-center gap-2 text-gray-600">
      <li>
        <a routerLink="/" class="hover:text-secondary transition-colors">
          Inicio
        </a>
      </li>
      <li>
        <span class="select-none">/</span>
      </li>
      <li>
        <a
          [routerLink]="['/products']"
          [queryParams]="{ category: prod.category }"
          class="hover:text-secondary transition-colors capitalize"
        >
          {{ prod.category }}
        </a>
      </li>
      <li>
        <span class="select-none">/</span>
      </li>
      <li class="font-medium text-primary truncate">
        {{ prod.name }}
      </li>
    </ol>
  </nav>

  <div
    class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-16 items-start"
    style="overflow: hidden"
  >
    <div class="w-full min-w-0">
      <div class="flex flex-col gap-4 sticky top-28 w-full">
        <div
          class="w-full flex justify-center aspect-square bg-gray-100 rounded-xl overflow-hidden shadow-sm"
        >
          <!-- 
            --- üëá CORRECCI√ìN 1 ---
            Cambiado (error) para llamar a la funci√≥n
          -->
          <img
            [src]="getProductImage()"
            [alt]="prod.name"
            class="max-w-full max-h-full object-contain rounded-xl"
            loading="eager"
            (error)="getPlaceholderImage($event)"
          />
        </div>

        <div class="grid grid-cols-5 gap-3">
          <button
            *ngFor="let image of prod.images"
            (click)="selectImage(image.imageUrl)"
            (mouseenter)="selectImage(image.imageUrl)"
            type="button"
            class="aspect-square rounded-lg overflow-hidden border-2 transition-all duration-300 group hover:opacity-95 hover:border-secondary"
            [ngClass]="{
              'border-secondary opacity-100':
                selectedImageUrl() === image.imageUrl,
              'border-gray-200 opacity-70':
                selectedImageUrl() !== image.imageUrl
            }"
            [attr.aria-label]="'Ver imagen ' + (image.displayOrder + 1)"
          >
            <!-- 
              --- üëá CORRECCI√ìN 2 ---
              Cambiado (error) para llamar a la funci√≥n
            -->
            <img
              [src]="backendUrl + image.imageUrl"
              (error)="getPlaceholderImage($event)"
              [alt]="prod.name + ' vista ' + (image.displayOrder + 1)"
              class="w-full h-full object-cover rounded-lg transform transition-transform duration-300 group-hover:scale-105"
            />
          </button>
        </div>
      </div>
    </div>

    <div class="flex flex-col gap-6 min-w-0">
      <div>
        <p
          *ngIf="prod.brand"
          class="text-sm font-semibold text-secondary uppercase tracking-wide"
        >
          {{ prod.brand }}
        </p>
        <h1 class="text-4xl font-bold text-gray-900 leading-tight mt-1">
          {{ prod.name }}
        </h1>

        <div
          class="flex items-center gap-2 mt-3"
          *ngIf="prod.ratingCount && prod.ratingCount > 0"
        >
          <div class="flex items-center gap-0.5">
            <svg
              *ngFor="let star of getStars()"
              class="w-5 h-5"
              [ngClass]="{
                'text-yellow-400': star !== 'empty',
                'text-gray-300': star === 'empty'
              }"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                *ngIf="star === 'full'"
                d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"
              />
              <path
                *ngIf="star === 'half'"
                d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0v15z"
              />
              <path
                *ngIf="star === 'empty'"
                d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545L10 15zm0 0"
                fill-rule="evenodd"
                clip-rule="evenodd"
                fill-opacity="0.5"
              />
            </svg>
          </div>
          <span class="text-sm text-gray-500">
            ({{ prod.ratingCount }} valoraciones)
          </span>
        </div>

        <div class="flex items-center gap-4 mt-3">
          <p class="text-3xl font-bold text-primary">
            {{ prod.price | currency : "EUR" : "symbol" : "1.2-2" }}
          </p>
          <p
            *ngIf="prod.oldPrice"
            class="text-2xl font-medium text-gray-400 line-through"
          >
            {{ prod.oldPrice | currency : "EUR" : "symbol" : "1.2-2" }}
          </p>
        </div>
      </div>

      <div *ngIf="availableColors().length > 0">
        <label class="block text-gray-800 font-medium mb-2">
          Selecciona tu color:
          <span class="text-gray-600 capitalize">{{ selectedColor() }}</span>
        </label>
        <div class="flex flex-wrap gap-3">
          <button
            *ngFor="let color of availableColors()"
            (click)="selectColor(color)"
            type="button"
            class="h-10 px-4 rounded-lg border text-sm font-medium transition-colors capitalize"
            [ngClass]="{
              'bg-secondary text-white border-secondary':
                selectedColor() === color,
              'bg-white text-gray-700 border-gray-300 hover:bg-gray-50':
                selectedColor() !== color
            }"
          >
            {{ color }}
          </button>
        </div>
      </div>
      <div *ngIf="availableSizes().length > 0">
        <div class="flex justify-between items-center mb-2">
          <label class="block text-gray-800 font-medium">
            Selecciona tu talla:
          </label>
          <button
            type="button"
            (click)="openSizeGuide()"
            class="text-sm font-medium text-secondary hover:underline"
          >
            Gu√≠a de tallas
          </button>
        </div>
        <div class="flex flex-wrap gap-3">
          <button
            *ngFor="let size of availableSizes()"
            (click)="selectSize(size)"
            type="button"
            class="h-10 px-4 rounded-lg border text-sm font-medium transition-colors"
            [ngClass]="{
              'bg-secondary text-white border-secondary':
                selectedSize() === size,
              'bg-white text-gray-700 border-gray-300 hover:bg-gray-50':
                selectedSize() !== size
            }"
          >
            {{ size }}
          </button>
        </div>
      </div>
      <div
        *ngIf="availableColors().length === 0"
        class="p-4 bg-red-50 text-red-700 rounded-lg"
      >
        <p class="font-medium">¬°Producto agotado!</p>
        <p class="text-sm">
          Este producto no tiene stock en ninguna de sus variantes.
        </p>
      </div>

      <div *ngIf="availableColors().length > 0">
        <label class="block text-gray-800 font-medium mb-2"> Cantidad: </label>
        <div class="flex items-center border border-gray-300 rounded-lg w-fit">
          <button
            (click)="decrementQuantity()"
            [disabled]="quantity() <= 1"
            class="h-10 w-10 text-xl text-gray-600 hover:bg-gray-100 disabled:opacity-50"
          >
            -
          </button>
          <span class="w-12 text-center font-medium">
            {{ quantity() }}
          </span>
          <button
            (click)="incrementQuantity()"
            class="h-10 w-10 text-xl text-gray-600 hover:bg-gray-100"
          >
            +
          </button>
        </div>
      </div>

      <div class="flex flex-col sm:flex-row gap-4 mt-2">
        <button
          class="flex-1 bg-secondary text-white py-3 px-8 rounded-xl font-medium text-lg shadow-sm hover:shadow-md transition-all duration-200 hover:bg-secondary-light disabled:opacity-50 disabled:cursor-not-allowed"
          (click)="buyNow()"
          [disabled]="!selectedVariantId()"
        >
          Comprar ahora
        </button>
        <button
          class="flex-1 py-3 px-8 rounded-xl font-medium text-lg text-primary bg-secondary/10 hover:bg-secondary/20 transition-all duration-200 shadow-sm hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed"
          (click)="addToCart()"
          [disabled]="!selectedVariantId()"
        >
          A√±adir a la cesta
        </button>
      </div>
    </div>
  </div>

  <div class="mt-16">
    <div class="border-b border-gray-200">
      <nav class="flex -mb-px gap-6">
        <button
          (click)="setActiveTab('description')"
          class="py-4 px-1 text-sm font-medium border-b-2 transition-colors"
          [ngClass]="{
            'border-secondary text-secondary': activeTab() === 'description',
            'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300':
              activeTab() !== 'description'
          }"
        >
          Descripci√≥n
        </button>
        <button
          (click)="setActiveTab('specs')"
          class="py-4 px-1 text-sm font-medium border-b-2 transition-colors"
          [ngClass]="{
            'border-secondary text-secondary': activeTab() === 'specs',
            'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300':
              activeTab() !== 'specs'
          }"
        >
          Especificaciones
        </button>
        <button
          *ngIf="prod.ratingCount && prod.ratingCount > 0"
          (click)="setActiveTab('reviews')"
          class="py-4 px-1 text-sm font-medium border-b-2 transition-colors"
          [ngClass]="{
            'border-secondary text-secondary': activeTab() === 'reviews',
            'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300':
              activeTab() !== 'reviews'
          }"
        >
          Valoraciones ({{ prod.ratingCount }})
        </button>
      </nav>
    </div>

    <div class="py-6">
      <div *ngIf="activeTab() === 'description'">
        <p class="text-gray-600 leading-relaxed">
          {{ prod.description }}
        </p>
      </div>
      <div *ngIf="activeTab() === 'specs'">
        <ul class="list-disc list-inside text-gray-600 space-y-2">
          <li *ngIf="prod.brand">
            <span class="font-medium">Marca:</span> {{ prod.brand }}
          </li>
          <li *ngIf="prod.color">
            <span class="font-medium">Color:</span> {{ prod.color }}
          </li>
          <li *ngIf="prod.material">
            <span class="font-medium">Material:</span> {{ prod.material }}
          </li>
          <li *ngIf="prod.gender">
            <span class="font-medium">G√©nero:</span> {{ prod.gender }}
          </li>
        </ul>
      </div>
      <div *ngIf="activeTab() === 'reviews'">
        <p class="text-gray-600">
          Mostrando {{ prod.ratingCount }} valoraciones... (Funcionalidad
          pendiente)
        </p>
      </div>
    </div>
  </div>

  <div class="mt-16">
    <app-related-products
      *ngIf="prod"
      [currentProductId]="prod.id"
    ></app-related-products>
  </div>
</main>

<ng-template #loadingOrError>
  <main class="max-w-4xl mx-auto px-4 py-24 text-center">
    <div *ngIf="isLoading()" class="animate-pulse text-lg text-gray-500">
      Cargando producto...
    </div>
    <div *ngIf="error()" class="text-red-500 font-medium">
      {{ error() }}
    </div>
  </main>
</ng-template>

<!-- 
  --- MODAL DE GU√çA DE TALLAS ---
-->
<div
  *ngIf="isSizeGuideOpen()"
  class="fixed inset-0 z-50 flex items-center justify-center p-4"
  role="dialog"
  aria-modal="true"
  aria-labelledby="size-guide-title"
>
  <!-- Backdrop (Fondo) -->
  <div
    (click)="closeSizeGuide()"
    class="absolute inset-0 bg-black/60 backdrop-blur-sm"
  ></div>

  <!-- Panel del Modal -->
  <div
    class="relative w-full max-w-3xl bg-white rounded-xl shadow-2xl overflow-hidden"
  >
    <!-- Encabezado del Modal -->
    <div class="flex items-center justify-between p-4 border-b border-gray-200">
      <h2 id="size-guide-title" class="text-xl font-semibold text-primary">
        Gu√≠a de Tallas
      </h2>
      <button
        (click)="closeSizeGuide()"
        class="text-gray-400 hover:text-secondary transition-colors"
        aria-label="Cerrar modal"
      >
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>

    <!-- Contenido del Modal (con scroll) -->
    <div class="p-6 max-h-[70vh] overflow-y-auto space-y-6">
      <!-- Tabla de Ropa -->
      <div>
        <h3 class="text-lg font-medium text-primary mb-3">
          Gu√≠a de Ropa (Unisex)
        </h3>
        <div class="overflow-x-auto rounded-lg border border-gray-200">
          <table class="w-full min-w-[500px] text-sm text-left">
            <thead class="bg-gray-50 text-xs text-gray-700 uppercase">
              <tr>
                <th scope="col" class="px-4 py-3">Talla</th>
                <th scope="col" class="px-4 py-3">Pecho (cm)</th>
                <th scope="col" class="px-4 py-3">Cintura (cm)</th>
                <th scope="col" class="px-4 py-3">Cadera (cm)</th>
              </tr>
            </thead>
            <tbody>
              <tr class="bg-white border-b">
                <td class="px-4 py-3 font-medium text-gray-900">XS</td>
                <td class="px-4 py-3">80-88</td>
                <td class="px-4 py-3">65-73</td>
                <td class="px-4 py-3">80-88</td>
              </tr>
              <tr class="bg-white border-b">
                <td class="px-4 py-3 font-medium text-gray-900">S</td>
                <td class="px-4 py-3">88-96</td>
                <td class="px-4 py-3">73-81</td>
                <td class="px-4 py-3">88-96</td>
              </tr>
              <tr class="bg-white border-b">
                <td class="px-4 py-3 font-medium text-gray-900">M</td>
                <td class="px-4 py-3">96-104</td>
                <td class="px-4 py-3">81-89</td>
                <td class="px-4 py-3">96-104</td>
              </tr>
              <tr class="bg-white border-b">
                <td class="px-4 py-3 font-medium text-gray-900">L</td>
                <td class="px-4 py-3">104-112</td>
                <td class="px-4 py-3">89-97</td>
                <td class="px-4 py-3">104-112</td>
              </tr>
              <tr class="bg-white border-b">
                <td class="px-4 py-3 font-medium text-gray-900">XL</td>
                <td class="px-4 py-3">112-124</td>
                <td class="px-4 py-3">97-109</td>
                <td class="px-4 py-3">112-120</td>
              </tr>
              <tr class="bg-white border-b">
                <td class="px-4 py-3 font-medium text-gray-900">XXL</td>
                <td class="px-4 py-3">124-136</td>
                <td class="px-4 py-3">109-121</td>
                <td class="px-4 py-3">120-128</td>
              </tr>
              <tr class="bg-white">
                <td class="px-4 py-3 font-medium text-gray-900">XXXL</td>
                <td class="px-4 py-3">136-148</td>
                <td class="px-4 py-3">121-133</td>
                <td class="px-4 py-3">128-136</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Tabla de Calzado -->
      <div>
        <h3 class="text-lg font-medium text-primary mb-3">
          Gu√≠a de Calzado (EUR)
        </h3>
        <div class="overflow-x-auto rounded-lg border border-gray-200">
          <table class="w-full min-w-[500px] text-sm text-left">
            <thead class="bg-gray-50 text-xs text-gray-700 uppercase">
              <tr>
                <th scope="col" class="px-4 py-3">EUR</th>
                <th scope="col" class="px-4 py-3">UK</th>
                <th scope="col" class="px-4 py-3">US (Hombre)</th>
                <th scope="col" class="px-4 py-3">US (Mujer)</th>
                <th scope="col" class="px-4 py-3">CM</th>
              </tr>
            </thead>
            <tbody>
              <tr class="bg-white border-b">
                <td class="px-4 py-3 font-medium">34</td>
                <td class="px-4 py-3">2</td>
                <td class="px-4 py-3">3</td>
                <td class="px-4 py-3">4.5</td>
                <td class="px-4 py-3">21.5</td>
              </tr>
              <tr class="bg-white border-b">
                <td class="px-4 py-3 font-medium">35</td>
                <td class="px-4 py-3">2.5</td>
                <td class="px-4 py-3">3.5</td>
                <td class="px-4 py-3">5</td>
                <td class="px-4 py-3">22</td>
              </tr>
              <tr class="bg-white border-b">
                <td class="px-4 py-3 font-medium">36</td>
                <td class="px-4 py-3">3.5</td>
                <td class="px-4 py-3">4.5</td>
                <td class="px-4 py-3">6</td>
                <td class="px-4 py-3">22.5</td>
              </tr>
              <tr class="bg-white border-b">
                <td class="px-4 py-3 font-medium">37</td>
                <td class="px-4 py-3">4.5</td>
                <td class="px-4 py-3">5.5</td>
                <td class="px-4 py-3">7</td>
                <td class="px-4 py-3">23.5</td>
              </tr>
              <tr class="bg-white border-b">
                <td class="px-4 py-3 font-medium">38</td>
                <td class="px-4 py-3">5</td>
                <td class="px-4 py-3">6</td>
                <td class="px-4 py-3">7.5</td>
                <td class="px-4 py-3">24</td>
              </tr>
              <tr class="bg-white border-b">
                <td class="px-4 py-3 font-medium">39</td>
                <td class="px-4 py-3">6</td>
                <td class="px-4 py-3">7</td>
                <td class="px-4 py-3">8.5</td>
                <td class="px-4 py-3">25</td>
              </tr>
              <tr class="bg-white border-b">
                <td class="px-4 py-3 font-medium">40</td>
                <td class="px-4 py-3">6.5</td>
                <td class="px-4 py-3">7.5</td>
                <td class="px-4 py-3">9</td>
                <td class="px-4 py-3">25.5</td>
              </tr>
              <tr class="bg-white border-b">
                <td class="px-4 py-3 font-medium">41</td>
                <td class="px-4 py-3">7.5</td>
                <td class="px-4 py-3">8.5</td>
                <td class="px-4 py-3">10</td>
                <td class="px-4 py-3">26.5</td>
              </tr>
              <tr class="bg-white border-b">
                <td class="px-4 py-3 font-medium">42</td>
                <td class="px-4 py-3">8</td>
                <td class="px-4 py-3">9</td>
                <td class="px-4 py-3">10.5</td>
                <td class="px-4 py-3">27</td>
              </tr>
              <tr class="bg-white border-b">
                <td class="px-4 py-3 font-medium">43</td>
                <td class="px-4 py-3">9</td>
                <td class="px-4 py-3">10</td>
                <td class="px-4 py-3">11.5</td>
                <td class="px-4 py-3">28</td>
              </tr>
              <tr class="bg-white border-b">
                <td class="px-4 py-3 font-medium">44</td>
                <td class="px-4 py-3">9.5</td>
                <td class="px-4 py-3">10.5</td>
                <td class="px-4 py-3">12</td>
                <td class="px-4 py-3">28.5</td>
              </tr>
              <tr class="bg-white">
                <td class="px-4 py-3 font-medium">45</td>
                <td class="px-4 py-3">10.5</td>
                <td class="px-4 py-3">11.5</td>
                <td class="px-4 py-3">13</td>
                <td class="px-4 py-3">29.5</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <p class="text-xs text-gray-500 text-center">
        * Estas gu√≠as son una referencia. Las tallas pueden variar ligeramente
        entre marcas.
      </p>
    </div>
  </div>
</div>
