<!-- src/app/products/components/product-detail/product-detail.component.html -->
<main
  class="max-w-7xl mx-auto px-4 py-8 sm:py-12"
  *ngIf="!isLoading() && product() as prod; else loadingOrError"
>
  <!-- 1. Breadcrumbs -->
  <nav class="text-sm mb-4" aria-label="Breadcrumb">
    <ol class="flex items-center gap-2 text-text-light-secondary">
      <li>
        <a routerLink="/" class="hover:text-primary transition-colors">
          Inicio
        </a>
      </li>
      <li>
        <span class="select-none">/</span>
      </li>
      <li>
        <a
          [routerLink]="['/products/category', prod.category]"
          class="hover:text-primary transition-colors capitalize"
        >
          {{ prod.category }}
        </a>
      </li>
      <li>
        <span class="select-none">/</span>
      </li>
      <li class="font-medium text-text-light-primary truncate">
        {{ prod.name }}
      </li>
    </ol>
  </nav>

  <!-- 2. Contenedor Principal -->
  <div
    class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-16 items-start"
    style="overflow: hidden"
  >
    <!-- Columna de Galería -->
    <div class="w-full min-w-0">
      <div class="flex flex-col gap-4 sticky top-28 w-full">
        <!-- Imagen Principal -->
        <div
          class="w-full flex justify-center aspect-square bg-gray-100 rounded-xl overflow-hidden shadow-sm"
        >
          <img
            [src]="getProductImage()"
            [alt]="prod.name"
            class="max-w-full max-h-full object-contain rounded-xl"
            loading="eager"
          />
        </div>

        <!-- Miniaturas -->
        <div class="grid grid-cols-5 gap-3">
          <button
            *ngFor="let image of prod.images"
            (click)="selectImage(image.imageUrl)"
            (mouseenter)="selectImage(image.imageUrl)"
            type="button"
            class="aspect-square rounded-lg overflow-hidden border-2 transition-all duration-300 group hover:opacity-95 hover:border-primary"
            [ngClass]="{
              'border-primary  opacity-100':
                selectedImageUrl() === image.imageUrl,
              'border-secondary opacity-70':
                selectedImageUrl() !== image.imageUrl
            }"
            [attr.aria-label]="'Ver imagen ' + (image.displayOrder + 1)"
          >
            <img
              [src]="backendUrl + image.imageUrl"
              [alt]="prod.name + ' vista ' + (image.displayOrder + 1)"
              class="w-full h-full object-cover rounded-lg transform transition-transform duration-300 group-hover:scale-105"
              [ngClass]="{
                'opacity-100': selectedImageUrl() === image.imageUrl,
                'opacity-70': selectedImageUrl() !== image.imageUrl
              }"
            />
          </button>
        </div>
      </div>
    </div>

    <!-- Columna de Información -->
    <div class="flex flex-col gap-6 min-w-0">
      <!-- Marca y Nombre -->
      <div>
        <p
          *ngIf="prod.brand"
          class="text-sm font-semibold text-secondary uppercase tracking-wide"
        >
          {{ prod.brand }}
        </p>
        <h1 class="text-4xl font-bold text-gray-900 leading-tight mt-1">
          {{ prod.name }}
        </h1>

        <!-- Valoraciones -->
        <div
          class="flex items-center gap-2 mt-3"
          *ngIf="prod.ratingCount && prod.ratingCount > 0"
        >
          <div class="flex items-center gap-0.5">
            <svg
              *ngFor="let star of getStars()"
              class="w-5 h-5"
              [ngClass]="{
                'text-yellow-400': star !== 'empty',
                'text-gray-300': star === 'empty'
              }"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                *ngIf="star === 'full'"
                d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"
              />
              <path
                *ngIf="star === 'half'"
                d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0v15z"
              />
              <path
                *ngIf="star === 'empty'"
                d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545L10 15zm0 0"
                fill-rule="evenodd"
                clip-rule="evenodd"
                fill-opacity="0.5"
              />
            </svg>
          </div>
          <span class="text-sm text-gray-500">
            ({{ prod.ratingCount }} valoraciones)
          </span>
        </div>

        <!-- Precio -->
        <div class="flex items-center gap-4 mt-3">
          <p class="text-3xl font-bold text-primary">
            {{ prod.price | currency : "EUR" : "symbol" : "1.2-2" }}
          </p>
          <p
            *ngIf="prod.oldPrice"
            class="text-2xl font-medium text-gray-400 line-through"
          >
            {{ prod.oldPrice | currency : "EUR" : "symbol" : "1.2-2" }}
          </p>
        </div>
      </div>

      <!-- 
        --- ¡NUEVA SECCIÓN DE VARIANTES (HERMANOS)! ---
      -->
      <div *ngIf="prod.variants.length > 0">
        <label class="block text-gray-800 font-medium mb-2">
          Otros Colores:
        </label>
        <div class="flex flex-wrap gap-3">
          <!-- Bucle sobre las variantes -->
          <a
            *ngFor="let variant of prod.variants"
            [routerLink]="['/products', 'product', variant.id]"
            class="block w-14 h-14 rounded-lg border-2 border-transparent hover:border-primary p-0.5 transition-all"
            [title]="variant.color | titlecase"
          >
            <img
              [src]="backendUrl + (variant.image || defaultImage)"
              alt="Variante color {{ variant.color }}"
              class="w-full h-full object-cover rounded-md"
            />
          </a>
        </div>
      </div>
      <!-- --- FIN DE LA SECCIÓN DE VARIANTES --- -->

      <!-- 
        --- ¡SELECTOR DE TALLA MODIFICADO! ---
      -->
      <div *ngIf="availableSizes().length > 0">
        <div class="flex justify-between items-center mb-2">
          <label class="block text-gray-800 font-medium">
            Selecciona tu talla:
          </label>
          <a
            href="#"
            class="text-sm font-medium text-secondary hover:underline"
          >
            Guía de tallas
          </a>
        </div>
        <div class="flex flex-wrap gap-3">
          <!-- Ahora usa la señal 'availableSizes()' -->
          <button
            *ngFor="let size of availableSizes()"
            (click)="selectSize(size)"
            type="button"
            class="h-10 px-4 rounded-lg border text-sm font-medium transition-colors"
            [ngClass]="{
              'bg-secondary text-white border-secondary':
                selectedSize() === size,
              'bg-white text-gray-700 border-gray-300 hover:bg-gray-50':
                selectedSize() !== size
            }"
          >
            {{ size }}
          </button>
        </div>
      </div>
      <!-- --- FIN DE TALLAS --- -->

      <!-- Selector de Cantidad -->
      <div>
        <label class="block text-gray-800 font-medium mb-2"> Cantidad: </label>
        <div class="flex items-center border border-gray-300 rounded-lg w-fit">
          <button
            (click)="decrementQuantity()"
            [disabled]="quantity() <= 1"
            class="h-10 w-10 text-xl text-gray-600 hover:bg-gray-100 disabled:opacity-50"
          >
            -
          </button>
          <span class="w-12 text-center font-medium">
            {{ quantity() }}
          </span>
          <button
            (click)="incrementQuantity()"
            class="h-10 w-10 text-xl text-gray-600 hover:bg-gray-100"
          >
            +
          </button>
        </div>
      </div>

      <!-- Botones de acción -->
      <div class="flex flex-col sm:flex-row gap-4 mt-2">
        <button
          class="flex-1 bg-secondary text-white py-3 px-8 rounded-xl font-medium text-lg shadow-sm hover:shadow-md transition-all duration-200 hover:bg-secondary-light disabled:opacity-50 disabled:cursor-not-allowed"
          (click)="buyNow()"
          [disabled]="availableSizes().length > 0 && !selectedSize()"
        >
          Comprar ahora
        </button>
        <button
          class="flex-1 py-3 px-8 rounded-xl font-medium text-lg text-primary bg-secondary/10 hover:bg-secondary/20 transition-all duration-200 shadow-sm hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed"
          (click)="addToCart()"
          [disabled]="availableSizes().length > 0 && !selectedSize()"
        >
          Añadir a la cesta
        </button>
      </div>
    </div>
  </div>

  <!-- 3. Pestañas de Información -->
  <div class="mt-16">
    <div class="border-b border-gray-200">
      <nav class="flex -mb-px gap-6">
        <button
          (click)="setActiveTab('description')"
          class="py-4 px-1 text-sm font-medium border-b-2 transition-colors"
          [ngClass]="{
            'border-secondary text-secondary': activeTab() === 'description',
            'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300':
              activeTab() !== 'description'
          }"
        >
          Descripción
        </button>
        <button
          (click)="setActiveTab('specs')"
          class="py-4 px-1 text-sm font-medium border-b-2 transition-colors"
          [ngClass]="{
            'border-secondary text-secondary': activeTab() === 'specs',
            'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300':
              activeTab() !== 'specs'
          }"
        >
          Especificaciones
        </button>
        <button
          *ngIf="prod.ratingCount && prod.ratingCount > 0"
          (click)="setActiveTab('reviews')"
          class="py-4 px-1 text-sm font-medium border-b-2 transition-colors"
          [ngClass]="{
            'border-secondary text-secondary': activeTab() === 'reviews',
            'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300':
              activeTab() !== 'reviews'
          }"
        >
          Valoraciones ({{ prod.ratingCount }})
        </button>
      </nav>
    </div>

    <div class="py-6">
      <div *ngIf="activeTab() === 'description'">
        <p class="text-gray-600 leading-relaxed">
          {{ prod.description }}
        </p>
      </div>
      <div *ngIf="activeTab() === 'specs'">
        <ul class="list-disc list-inside text-gray-600 space-y-2">
          <li *ngIf="prod.brand">
            <span class="font-medium">Marca:</span> {{ prod.brand }}
          </li>
          <li *ngIf="prod.color">
            <span class="font-medium">Color:</span> {{ prod.color }}
          </li>
          <li *ngIf="prod.material">
            <span class="font-medium">Material:</span> {{ prod.material }}
          </li>
          <li *ngIf="prod.gender">
            <span class="font-medium">Género:</span> {{ prod.gender }}
          </li>
        </ul>
      </div>
      <div *ngIf="activeTab() === 'reviews'">
        <p class="text-gray-600">
          Mostrando {{ prod.ratingCount }} valoraciones... (Funcionalidad
          pendiente)
        </p>
      </div>
    </div>
  </div>

  <!-- Sección de Productos Relacionados -->
  <div class="mt-16">
    <app-related-products
      *ngIf="prod"
      [currentProductId]="prod.id"
    ></app-related-products>
  </div>
</main>

<!-- Estado de carga o error -->
<ng-template #loadingOrError>
  <main class="max-w-4xl mx-auto px-4 py-24 text-center">
    <div *ngIf="isLoading()" class="animate-pulse text-lg text-gray-500">
      Cargando producto...
    </div>
    <div *ngIf="error()" class="text-red-500 font-medium">
      {{ error() }}
    </div>
  </main>
</ng-template>
