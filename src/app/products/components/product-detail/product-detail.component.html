<main
  class="max-w-7xl mx-auto px-4 py-8 sm:py-12"
  *ngIf="!isLoading() && product() as prod; else loadingOrError"
>
  <nav class="text-sm mb-4" aria-label="Breadcrumb">
    <ol class="flex items-center gap-2 text-gray-600">
      <li>
        <a routerLink="/" class="hover:text-secondary transition-colors">
          Inicio
        </a>
      </li>
      <li><span class="select-none">/</span></li>

      <li>
        <!-- CORRECCIÓN AQUÍ: Usamos routerLink array para path params -->
        <!-- Antes: [queryParams]="{ category: prod.category }" -->
        <!-- Ahora: ['/products', 'category', prod.category] -->
        <a
          [routerLink]="['/products', 'category', prod.category]"
          class="hover:text-secondary transition-colors capitalize"
        >
          {{ prod.category }}
        </a>
      </li>

      <li><span class="select-none">/</span></li>

      <li class="font-medium text-primary truncate">
        {{ prod.name }}
      </li>
    </ol>
  </nav>

  <div
    class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-16 items-start"
    style="overflow: hidden"
  >
    <!-- IMAGEN PRINCIPAL -->
    <div class="w-full min-w-0">
      <div class="flex flex-col gap-4 sticky top-28 w-full">
        <div
          class="w-full flex justify-center aspect-square bg-gray-100 rounded-xl overflow-hidden shadow-sm relative"
        >
          <img
            [src]="getProductImage()"
            [alt]="prod.name"
            class="max-w-full max-h-full object-contain rounded-xl"
            loading="eager"
            (error)="getPlaceholderImage($event)"
          />

          <div
            *ngIf="availableColors().length === 0"
            class="absolute top-4 right-4 bg-red-500 text-white px-3 py-1 rounded-full text-sm font-bold"
          >
            Agotado
          </div>
        </div>

        <!-- MINIATURAS -->
        <div class="grid grid-cols-5 gap-3" *ngIf="currentImages().length > 1">
          <button
            *ngFor="let image of currentImages()"
            (click)="selectImage(image.imageUrl)"
            (mouseenter)="selectImage(image.imageUrl)"
            type="button"
            class="aspect-square rounded-lg overflow-hidden border-2 transition-all duration-300 group hover:opacity-95 hover:border-secondary"
            [ngClass]="{
              'border-secondary opacity-100':
                selectedImageUrl() === image.imageUrl ||
                (!selectedImageUrl() && image === currentImages()[0]),
              'border-gray-200 opacity-70':
                selectedImageUrl() !== image.imageUrl
            }"
            [attr.aria-label]="'Ver imagen ' + (image.displayOrder + 1)"
          >
            <img
              [src]="backendUrl + image.imageUrl"
              (error)="getPlaceholderImage($event)"
              [alt]="prod.name + ' vista ' + (image.displayOrder + 1)"
              class="w-full h-full object-cover rounded-lg transform transition-transform duration-300 group-hover:scale-105"
            />
          </button>
        </div>
      </div>
    </div>

    <!-- INFORMACIÓN DEL PRODUCTO -->
    <div class="flex flex-col gap-6 min-w-0">
      <div>
        <p
          *ngIf="prod.brand"
          class="text-sm font-semibold text-secondary uppercase tracking-wide"
        >
          {{ prod.brand }}
        </p>

        <h1 class="text-4xl font-bold text-gray-900 leading-tight mt-1">
          {{ prod.name }}
        </h1>

        <!-- ESTRELLAS -->
        <div
          class="flex items-center gap-2 mt-3"
          *ngIf="prod.ratingCount && prod.ratingCount > 0"
        >
          <div class="flex items-center gap-0.5">
            <svg
              *ngFor="let star of getStars()"
              class="w-5 h-5"
              [ngClass]="{
                'text-yellow-400': star !== 'empty',
                'text-gray-300': star === 'empty'
              }"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                *ngIf="star === 'full'"
                d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"
              />
              <path
                *ngIf="star === 'half'"
                d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0v15z"
              />
              <path
                *ngIf="star === 'empty'"
                d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545L10 15zm0 0"
                fill-rule="evenodd"
                clip-rule="evenodd"
                fill-opacity="0.5"
              />
            </svg>
          </div>

          <span class="text-sm text-gray-500">
            ({{ prod.ratingCount }} valoraciones)
          </span>
        </div>

        <!-- PRECIO -->
        <div class="flex items-center gap-4 mt-3">
          <p class="text-3xl font-bold text-primary">
            {{ currentPrice() | currency : "EUR" : "symbol" : "1.2-2" }}
          </p>

          <p
            *ngIf="prod.oldPrice"
            class="text-2xl font-medium text-gray-400 line-through"
          >
            {{ prod.oldPrice | currency : "EUR" : "symbol" : "1.2-2" }}
          </p>
        </div>
      </div>

      <!-- COLORES -->
      <div *ngIf="availableColors().length > 0">
        <label class="block text-gray-800 font-medium mb-2">
          Selecciona tu color:
          <span class="text-gray-600 capitalize">{{ selectedColor() }}</span>
        </label>

        <div class="flex flex-wrap gap-3">
          <button
            *ngFor="let color of availableColors()"
            (click)="selectColor(color)"
            type="button"
            class="h-10 px-4 rounded-lg border text-sm font-medium transition-colors capitalize"
            [ngClass]="{
              'bg-secondary text-white border-secondary':
                selectedColor() === color,
              'bg-white text-gray-700 border-gray-300 hover:bg-gray-50':
                selectedColor() !== color
            }"
          >
            {{ color }}
          </button>
        </div>
      </div>

      <!-- TALLAS -->
      <div *ngIf="availableSizes().length > 0">
        <div class="flex justify-between items-center mb-2">
          <label class="block text-gray-800 font-medium">
            Selecciona tu talla:
          </label>

          <button
            type="button"
            (click)="openSizeGuide()"
            class="text-sm font-medium text-secondary hover:underline"
          >
            Guía de tallas
          </button>
        </div>

        <div class="flex flex-wrap gap-3">
          <button
            *ngFor="let size of availableSizes()"
            (click)="selectSize(size)"
            type="button"
            class="h-10 px-4 rounded-lg border text-sm font-medium transition-colors"
            [ngClass]="{
              'bg-secondary text-white border-secondary':
                selectedSize() === size,
              'bg-white text-gray-700 border-gray-300 hover:bg-gray-50':
                selectedSize() !== size
            }"
          >
            {{ size }}
          </button>
        </div>
      </div>

      <!-- PRODUCTO AGOTADO -->
      <div
        *ngIf="availableColors().length === 0"
        class="p-4 bg-red-50 text-red-700 rounded-lg"
      >
        <p class="font-medium">¡Producto agotado!</p>
        <p class="text-sm">
          Este producto no tiene stock en ninguna de sus variantes.
        </p>
      </div>

      <!-- CANTIDAD -->
      <div *ngIf="availableColors().length > 0">
        <label class="block text-gray-800 font-medium mb-2"> Cantidad: </label>

        <div class="flex items-center border border-gray-300 rounded-lg w-fit">
          <button
            (click)="decrementQuantity()"
            [disabled]="quantity() <= 1"
            class="h-10 w-10 text-xl text-gray-600 hover:bg-gray-100 disabled:opacity-50"
          >
            -
          </button>

          <span class="w-12 text-center font-medium">
            {{ quantity() }}
          </span>

          <button
            (click)="incrementQuantity()"
            class="h-10 w-10 text-xl text-gray-600 hover:bg-gray-100"
          >
            +
          </button>
        </div>
      </div>

      <!-- BOTONES -->
      <div class="flex flex-col sm:flex-row gap-4 mt-2">
        <button
          class="flex-1 bg-secondary text-white py-3 px-8 rounded-xl font-medium text-lg shadow-sm hover:shadow-md transition-all duration-200 hover:bg-secondary-light disabled:opacity-50 disabled:cursor-not-allowed"
          (click)="buyNow()"
          [disabled]="!selectedVariantId()"
        >
          Comprar ahora
        </button>

        <button
          class="flex-1 py-3 px-8 rounded-xl font-medium text-lg text-primary bg-secondary/10 hover:bg-secondary/20 transition-all duration-200 shadow-sm hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed"
          (click)="addToCart()"
          [disabled]="!selectedVariantId()"
        >
          Añadir a la cesta
        </button>
      </div>
    </div>
  </div>

  <!-- SECCIÓN TABS -->
  <div class="mt-16">
    <div class="border-b border-gray-200">
      <nav class="flex -mb-px gap-6">
        <button
          (click)="setActiveTab('description')"
          class="py-4 px-1 text-sm font-medium border-b-2 transition-colors"
          [ngClass]="{
            'border-secondary text-secondary': activeTab() === 'description',
            'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300':
              activeTab() !== 'description'
          }"
        >
          Descripción
        </button>

        <button
          (click)="setActiveTab('specs')"
          class="py-4 px-1 text-sm font-medium border-b-2 transition-colors"
          [ngClass]="{
            'border-secondary text-secondary': activeTab() === 'specs',
            'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300':
              activeTab() !== 'specs'
          }"
        >
          Especificaciones
        </button>

        <button
          *ngIf="prod.ratingCount && prod.ratingCount > 0"
          (click)="setActiveTab('reviews')"
          class="py-4 px-1 text-sm font-medium border-b-2 transition-colors"
          [ngClass]="{
            'border-secondary text-secondary': activeTab() === 'reviews',
            'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300':
              activeTab() !== 'reviews'
          }"
        >
          Valoraciones ({{ prod.ratingCount }})
        </button>
      </nav>
    </div>

    <div class="py-6">
      <div *ngIf="activeTab() === 'description'">
        <p class="text-gray-600 leading-relaxed">
          {{ prod.description }}
        </p>
      </div>

      <div *ngIf="activeTab() === 'specs'">
        <ul class="list-disc list-inside text-gray-600 space-y-2">
          <li *ngIf="prod.brand">
            <span class="font-medium">Marca:</span> {{ prod.brand }}
          </li>

          <li *ngIf="prod.color">
            <span class="font-medium">Color:</span> {{ prod.color }}
          </li>

          <li *ngIf="prod.material">
            <span class="font-medium">Material:</span> {{ prod.material }}
          </li>

          <li *ngIf="prod.gender">
            <span class="font-medium">Género:</span> {{ prod.gender }}
          </li>
        </ul>
      </div>

      <div *ngIf="activeTab() === 'reviews'">
        <p class="text-gray-600">
          Mostrando {{ prod.ratingCount }} valoraciones...
        </p>
      </div>
    </div>
  </div>

  <!-- PRODUCTOS RELACIONADOS -->
  <div class="mt-16">
    <app-related-products
      *ngIf="prod"
      [currentProductId]="prod.id"
    ></app-related-products>
  </div>
</main>

<!-- CARGA O ERROR -->
<ng-template #loadingOrError>
  <main class="max-w-4xl mx-auto px-4 py-24 text-center">
    <div *ngIf="isLoading()" class="animate-pulse text-lg text-gray-500">
      Cargando producto...
    </div>

    <div *ngIf="error()" class="text-red-500 font-medium">
      {{ error() }}
    </div>
  </main>
</ng-template>

<!-- MODAL GUÍA DE TALLAS -->
<div
  *ngIf="isSizeGuideOpen()"
  class="fixed inset-0 z-50 flex items-center justify-center p-4"
  role="dialog"
  aria-modal="true"
  aria-labelledby="size-guide-title"
>
  <div
    (click)="closeSizeGuide()"
    class="absolute inset-0 bg-black/60 backdrop-blur-sm"
  ></div>

  <div
    class="relative w-full max-w-3xl bg-white rounded-xl shadow-2xl overflow-hidden"
  >
    <div class="flex items-center justify-between p-4 border-b border-gray-200">
      <h2 id="size-guide-title" class="text-xl font-semibold text-primary">
        Guía de Tallas
      </h2>

      <button
        (click)="closeSizeGuide()"
        class="text-gray-400 hover:text-secondary transition-colors"
        aria-label="Cerrar modal"
      >
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>

    <div class="p-6 max-h-[70vh] overflow-y-auto space-y-6">
      <!-- TABLA ROPA -->
      <div>
        <h3 class="text-lg font-medium text-primary mb-3">
          Guía de Ropa (Unisex)
        </h3>

        <div class="overflow-x-auto rounded-lg border border-gray-200">
          <table class="w-full min-w-[500px] text-sm text-left">
            <thead class="bg-gray-50 text-xs text-gray-700 uppercase">
              <tr>
                <th class="px-4 py-3">Talla</th>
                <th class="px-4 py-3">Pecho (cm)</th>
                <th class="px-4 py-3">Cintura (cm)</th>
                <th class="px-4 py-3">Cadera (cm)</th>
              </tr>
            </thead>

            <tbody>
              <tr
                class="bg-white border-b"
                *ngFor="
                  let row of [
                    { t: 'XS', p: '80-88', c: '65-73', ca: '80-88' },
                    { t: 'S', p: '88-96', c: '73-81', ca: '88-96' },
                    { t: 'M', p: '96-104', c: '81-89', ca: '96-104' },
                    { t: 'L', p: '104-112', c: '89-97', ca: '104-112' },
                    { t: 'XL', p: '112-124', c: '97-109', ca: '112-120' },
                    { t: 'XXL', p: '124-136', c: '109-121', ca: '120-128' },
                    { t: 'XXXL', p: '136-148', c: '121-133', ca: '128-136' }
                  ]
                "
              >
                <td class="px-4 py-3 font-medium text-gray-900">{{ row.t }}</td>
                <td class="px-4 py-3">{{ row.p }}</td>
                <td class="px-4 py-3">{{ row.c }}</td>
                <td class="px-4 py-3">{{ row.ca }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- TABLA CALZADO -->
      <div>
        <h3 class="text-lg font-medium text-primary mb-3">
          Guía de Calzado (EUR)
        </h3>

        <div class="overflow-x-auto rounded-lg border border-gray-200">
          <table class="w-full min-w-[500px] text-sm text-left">
            <thead class="bg-gray-50 text-xs text-gray-700 uppercase">
              <tr>
                <th class="px-4 py-3">EUR</th>
                <th class="px-4 py-3">UK</th>
                <th class="px-4 py-3">US (Hombre)</th>
                <th class="px-4 py-3">US (Mujer)</th>
                <th class="px-4 py-3">CM</th>
              </tr>
            </thead>

            <tbody>
              <tr
                class="bg-white border-b"
                *ngFor="
                  let row of [
                    { e: 34, uk: 2, usH: 3, usM: 4.5, cm: 21.5 },
                    { e: 35, uk: 2.5, usH: 3.5, usM: 5, cm: 22 },
                    { e: 36, uk: 3.5, usH: 4.5, usM: 6, cm: 22.5 },
                    { e: 37, uk: 4, usH: 5, usM: 6.5, cm: 23 },
                    { e: 38, uk: 5, usH: 6, usM: 7.5, cm: 24 },
                    { e: 39, uk: 6, usH: 7, usM: 8.5, cm: 25 },
                    { e: 40, uk: 6.5, usH: 7.5, usM: 9, cm: 25.5 }
                  ]
                "
              >
                <td class="px-4 py-3 font-medium">{{ row.e }}</td>
                <td class="px-4 py-3">{{ row.uk }}</td>
                <td class="px-4 py-3">{{ row.usH }}</td>
                <td class="px-4 py-3">{{ row.usM }}</td>
                <td class="px-4 py-3">{{ row.cm }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
