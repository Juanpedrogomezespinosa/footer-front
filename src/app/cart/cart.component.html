<div *ngIf="isLoading()" class="flex justify-center items-center py-40">
  <div
    class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"
  ></div>
</div>

<div *ngIf="error()" class="max-w-6xl mx-auto px-4 py-16 text-center">
  <h2 class="text-2xl font-bold text-red-600">¡Oops! Hubo un error</h2>
  <p class="text-text-muted-light mt-2">{{ error() }}</p>
  <button
    (click)="loadCart()"
    class="mt-6 bg-primary text-white px-5 py-2 rounded-lg font-semibold hover:bg-primary-dark transition-colors"
  >
    Reintentar
  </button>
</div>

<main
  *ngIf="!isLoading() && !error()"
  class="flex-grow container mx-auto px-4 py-8 md:py-16"
>
  <div class="mx-auto max-w-6xl">
    <div class="mb-8 md:mb-12">
      <h1
        class="font-heading text-4xl md:text-5xl font-black tracking-tighter text-text-dark"
      >
        Mi Cesta de la Compra
      </h1>
    </div>

    <div *ngIf="cartItems().length > 0; else emptyCart">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 lg:gap-12">
        <div class="lg:col-span-2 space-y-4">
          <div
            *ngFor="let item of cartItems()"
            class="flex gap-4 bg-surface-light p-4 rounded-xl border border-border-light shadow-sm"
          >
            <div class="flex-shrink-0">
              <div
                class="bg-center bg-no-repeat aspect-square bg-cover rounded-lg w-24 h-24 md:w-28 md:h-28"
                [style.background-image]="
                  'url(' + getProductImage(item.product.image) + ')'
                "
                [attr.aria-label]="item.product.name"
              ></div>
            </div>

            <div class="flex flex-1 flex-col justify-between">
              <div>
                <p
                  class="text-base md:text-lg font-semibold leading-tight text-text-dark"
                >
                  {{ item.product.name }}
                </p>

                <p
                  *ngIf="item.variant.size"
                  class="text-text-muted-light text-sm mt-1"
                >
                  Talla: {{ item.variant.size }}
                </p>
                <p class="text-text-muted-light text-sm mt-2 md:hidden">
                  {{ item.product.price | currency : "EUR" }}
                </p>
              </div>
              <div class="flex items-center gap-3">
                <button
                  (click)="updateQuantity(item, -1)"
                  class="text-base font-medium flex h-8 w-8 items-center justify-center rounded-full bg-background-main cursor-pointer transition-transform active:scale-90 border border-border-light hover:bg-gray-200"
                  aria-label="Reducir cantidad"
                >
                  -
                </button>
                <span
                  class="text-base font-semibold w-5 text-center text-text-dark"
                >
                  {{ item.quantity }}
                </span>
                <button
                  (click)="updateQuantity(item, 1)"
                  class="text-base font-medium flex h-8 w-8 items-center justify-center rounded-full bg-background-main cursor-pointer transition-transform active:scale-90 border border-border-light hover:bg-gray-200"
                  aria-label="Aumentar cantidad"
                >
                  +
                </button>
              </div>
            </div>

            <div class="flex flex-col justify-between items-end">
              <p
                class="text-lg font-semibold leading-normal hidden md:block text-text-dark"
              >
                {{ item.product.price | currency : "EUR" }}
              </p>
              <button
                (click)="removeItem(item.id)"
                class="text-text-muted-light hover:text-primary transition-colors"
                aria-label="Eliminar producto"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  class="w-6 h-6"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12.578 0a48.108 48.108 0 0 1 3.478-.397m7.5 0a48.667 48.667 0 0 0-7.5 0"
                  />
                </svg>
              </button>
            </div>
          </div>
        </div>

        <aside class="lg:col-span-1">
          <div
            class="sticky top-28 bg-surface-light p-6 rounded-xl border border-border-light shadow-sm"
          >
            <h2
              class="font-heading text-2xl font-bold tracking-tight mb-6 text-text-dark"
            >
              Resumen del Pedido
            </h2>

            <div class="border-b border-border-light pb-6 mb-6">
              <h3 class="text-base font-semibold text-text-dark mb-4">
                Dirección de Envío
              </h3>

              <div *ngIf="isLoadingAddresses()">
                <div
                  class="h-10 bg-gray-200 rounded animate-pulse w-full"
                ></div>
              </div>

              <div
                *ngIf="!isLoadingAddresses() && addresses().length > 0"
                class="flex flex-col gap-3"
              >
                <div
                  *ngFor="let address of addresses()"
                  (click)="onSelectAddress(address.id)"
                  class="p-4 rounded-lg border-2 cursor-pointer transition-all"
                  [ngClass]="{
                    'border-secondary bg-secondary/5':
                      selectedAddressId() === address.id,
                    'border-border-light hover:border-gray-400':
                      selectedAddressId() !== address.id
                  }"
                >
                  <p
                    class="font-semibold text-sm text-text-dark flex justify-between"
                  >
                    {{ address.alias }}
                    <span
                      *ngIf="selectedAddressId() === address.id"
                      class="text-secondary"
                    >
                      ✓
                    </span>
                  </p>
                  <p class="text-xs text-text-muted-light mt-1 leading-snug">
                    {{ address.street }}, {{ address.city }},
                    {{ address.postalCode }}
                  </p>
                </div>
              </div>

              <div
                *ngIf="!isLoadingAddresses() && addresses().length === 0"
                class="text-center p-4 bg-gray-50 rounded-lg"
              >
                <p class="text-sm text-text-muted-light">
                  No tienes direcciones guardadas.
                </p>
                <a
                  routerLink="/profile/addresses"
                  class="text-sm font-semibold text-secondary hover:underline mt-2 inline-block"
                >
                  Añadir una dirección
                </a>
              </div>
            </div>
            <div class="space-y-4">
              <div class="flex justify-between items-center text-base">
                <span class="text-text-muted-light">Subtotal</span>
                <span class="font-semibold text-text-dark">
                  {{ subtotal() | currency : "EUR" }}
                </span>
              </div>
              <div class="flex justify-between items-center text-base">
                <span class="text-text-muted-light">Impuestos (IVA 21%)</span>
                <span class="font-semibold text-text-dark">
                  {{ taxes() | currency : "EUR" }}
                </span>
              </div>
              <div class="border-t border-border-light my-4"></div>
              <div class="flex justify-between items-center text-xl">
                <span class="font-bold text-text-dark">Total</span>
                <span class="font-bold text-text-dark">
                  {{ total() | currency : "EUR" }}
                </span>
              </div>
            </div>

            <button
              (click)="onCheckout()"
              class="mt-8 flex w-full items-center justify-center rounded-lg h-14 bg-secondary text-white text-lg font-bold tracking-wide transition-colors hover:bg-secondary-dark active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed"
              [disabled]="
                isLoading() || cartItems().length === 0 || !selectedAddressId()
              "
            >
              Pagar de forma segura
            </button>
            <p
              *ngIf="!selectedAddressId() && !isLoadingAddresses()"
              class="text-xs text-red-600 text-center mt-3"
            >
              Debes seleccionar una dirección de envío para continuar.
            </p>
          </div>
        </aside>
      </div>
    </div>

    <ng-template #emptyCart>
      <div
        class="text-center py-20 border border-border-light rounded-xl bg-surface-light"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1"
          stroke="currentColor"
          class="w-20 h-20 mx-auto text-text-muted-light"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M15.75 10.5V6a3.75 3.75 0 1 0-7.5 0v4.5m11.356-1.993 1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 0 1-1.12-1.243l1.264-12A1.125 1.125 0 0 1 5.513 7.5h12.974c.576 0 1.059.435 1.119 1.007ZM8.625 10.5a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm7.5 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z"
          />
        </svg>
        <h2 class="mt-6 text-2xl font-bold text-text-dark">
          Tu cesta está vacía
        </h2>
        <p class="mt-2 text-text-muted-light">
          Parece que aún no has añadido nada.
        </p>
        <a
          routerLink="/products"
          class="mt-8 inline-block bg-secondary text-white px-6 py-3 rounded-lg font-semibold hover:bg-secondaryc-dark transition-colors"
        >
          Explorar productos
        </a>
      </div>
    </ng-template>
  </div>
</main>
